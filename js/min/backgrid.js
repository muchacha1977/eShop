(function(f,g){"function"===typeof define&&define.amd?define(["underscore","backbone"],function(l,k){return f.Backgrid=g(l,k)}):"object"===typeof exports?module.exports=g(require("underscore"),require("backbone")):f.Backgrid=g(f._,f.Backbone)})(this,function(f,g){function l(a,b,c){b-=(a+"").length;b=0>b?0:b;for(var d="",h=0;h<b;h++)d+=c;return d+a}var k="\t\n\x0B\f\r \u00a0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029\ufeff";if(!String.prototype.trim||
k.trim()){var k="["+k+"]",E=RegExp("^"+k+k+"*"),F=RegExp(k+k+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(E,"").replace(F,"")}}var w=g.$,e={Extension:{},resolveNameToClass:function(a,b){if(f.isString(a)){var c=f.map(a.split("-"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")+b,d=e[c]||e.Extension[c];if(f.isUndefined(d))throw new ReferenceError("Class '"+c+"' not found");
return d}return a},callByNeed:function(){var a=arguments[0];if(!f.isFunction(a))return a;var b=arguments[1],c=[].slice.call(arguments,2);return a.apply(b,c+""?c:[])}};f.extend(e,g.Events);var q=e.Command=function(a){f.extend(this,{altKey:!!a.altKey,"char":a["char"],charCode:a.charCode,ctrlKey:!!a.ctrlKey,key:a.key,keyCode:a.keyCode,locale:a.locale,location:a.location,metaKey:!!a.metaKey,repeat:!!a.repeat,shiftKey:!!a.shiftKey,which:a.which})};f.extend(q.prototype,{moveUp:function(){return 38==this.keyCode},
moveDown:function(){return 40===this.keyCode},moveLeft:function(){return this.shiftKey&&9===this.keyCode},moveRight:function(){return!this.shiftKey&&9===this.keyCode},save:function(){return 13===this.keyCode},cancel:function(){return 27===this.keyCode},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var n=e.CellFormatter=function(){};f.extend(n.prototype,{fromRaw:function(a,b){return a},toRaw:function(a,b){return a}});var m=
e.NumberFormatter=function(a){f.extend(this,this.defaults,a||{});if(0>this.decimals||20<this.decimals)throw new RangeError("decimals must be between 0 and 20");};m.prototype=new n;f.extend(m.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(a,b){if(f.isNull(a)||f.isUndefined(a))return"";a=a.toFixed(~~this.decimals);var c=a.split("."),d=c[1]?(this.decimalSeparator||".")+c[1]:"";return c[0].replace(this.HUMANIZED_NUM_RE,
"$1"+this.orderSeparator)+d},toRaw:function(a,b){a=a.trim();if(""===a)return null;for(var c="",d=a.split(this.orderSeparator),h=0;h<d.length;h++)c+=d[h];d=c.split(this.decimalSeparator);c="";for(h=0;h<d.length;h++)c=c+d[h]+".";"."===c[c.length-1]&&(c=c.slice(0,c.length-1));c=1*(1*c).toFixed(~~this.decimals);if(f.isNumber(c)&&!f.isNaN(c))return c}});var r=e.PercentFormatter=function(){e.NumberFormatter.apply(this,arguments)};r.prototype=new e.NumberFormatter;f.extend(r.prototype,{defaults:f.extend({},
m.prototype.defaults,{multiplier:1,symbol:"%"}),fromRaw:function(a,b){var c=[].slice.call(arguments,1);c.unshift(a*this.multiplier);return(m.prototype.fromRaw.apply(this,c)||"0")+this.symbol},toRaw:function(a,b){var c=a.split(this.symbol);if(c&&c[0]&&""===c[1]||null==c[1])return c=m.prototype.toRaw.call(this,c[0]),f.isUndefined(c)?c:c/this.multiplier}});var v=e.DatetimeFormatter=function(a){f.extend(this,this.defaults,a||{});if(!this.includeDate&&!this.includeTime)throw Error("Either includeDate or includeTime must be true");
};v.prototype=new n;f.extend(v.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(a,b){if(""===(a+"").trim())return null;var c,d=null;f.isNumber(a)?(d=new Date(a),c=l(d.getUTCFullYear(),4,0)+"-"+l(d.getUTCMonth()+1,2,0)+"-"+l(d.getUTCDate(),2,0),d=l(d.getUTCHours(),2,0)+":"+l(d.getUTCMinutes(),2,0)+":"+l(d.getUTCSeconds(),2,0)):(a=a.trim(),d=a.split(this.ISO_SPLITTER_RE)||
[],d=(c=this.DATE_RE.test(d[0])?d[0]:"")&&d[1]?d[1]:this.TIME_RE.test(d[0])?d[0]:"");var h=this.DATE_RE.exec(c)||[],e=this.TIME_RE.exec(d)||[];if(!b||!(this.includeDate&&f.isUndefined(h[0])||this.includeTime&&f.isUndefined(e[0])||!this.includeDate&&c||!this.includeTime&&d))return d=new Date(Date.UTC(1*h[1]||0,1*h[2]-1||0,1*h[3]||0,1*e[1]||null,1*e[2]||null,1*e[3]||null,1*e[5]||null)),c="",this.includeDate&&(c=l(d.getUTCFullYear(),4,0)+"-"+l(d.getUTCMonth()+1,2,0)+"-"+l(d.getUTCDate(),2,0)),this.includeTime&&
(c=c+(this.includeDate?"T":"")+l(d.getUTCHours(),2,0)+":"+l(d.getUTCMinutes(),2,0)+":"+l(d.getUTCSeconds(),2,0),this.includeMilli&&(c=c+"."+l(d.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(c+="Z"),c},fromRaw:function(a,b){return f.isNull(a)||f.isUndefined(a)?"":this._convert(a)},toRaw:function(a,b){return this._convert(a,!0)}});var y=e.StringFormatter=function(){};y.prototype=new n;f.extend(y.prototype,{fromRaw:function(a,b){return f.isUndefined(a)||f.isNull(a)?"":a+""}});var z=
e.EmailFormatter=function(){};z.prototype=new n;f.extend(z.prototype,{toRaw:function(a,b){var c=a.trim().split("@");if(2===c.length&&f.all(c))return a}});k=e.SelectFormatter=function(){};k.prototype=new n;f.extend(k.prototype,{fromRaw:function(a,b){return f.isArray(a)?a:null!=a?[a]:[]}});var s=e.CellEditor=g.View.extend({initialize:function(a){this.formatter=a.formatter;this.column=a.column;this.column instanceof p||(this.column=new p(this.column));this.listenTo(this.model,"backgrid:editing",this.postRender)},
postRender:function(a,b){null!=b&&b.get("name")!=this.column.get("name")||this.$el.focus();return this}}),C=e.InputCellEditor=s.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(a){C.__super__.initialize.apply(this,arguments);a.placeholder&&this.$el.attr("placeholder",a.placeholder)},render:function(){var a=this.model;this.$el.val(this.formatter.fromRaw(a.get(this.column.get("name")),a));return this},saveOrCancel:function(a){var b=
this.formatter,c=this.model,d=this.column,h=new q(a),e="blur"===a.type;h.moveUp()||h.moveDown()||h.moveLeft()||h.moveRight()||h.save()||e?(a.preventDefault(),a.stopPropagation(),a=this.$el.val(),b=b.toRaw(a,c),f.isUndefined(b)?c.trigger("backgrid:error",c,d,a):(c.set(d.get("name"),b),c.trigger("backgrid:edited",c,d,h))):h.cancel()&&(a.stopPropagation(),c.trigger("backgrid:edited",c,d,h))},postRender:function(a,b){if(null==b||b.get("name")==this.column.get("name"))if("right"===this.$el.css("text-align")){var c=
this.$el.val();this.$el.focus().val(null).val(c)}else this.$el.focus();return this}}),t=e.Cell=g.View.extend({tagName:"td",formatter:n,editor:C,events:{click:"enterEditMode"},initialize:function(a){this.column=a.column;this.column instanceof p||(this.column=new p(this.column));a=this.column;var b=this.model,c=this.$el,d=e.resolveNameToClass(a.get("formatter")||this.formatter,"Formatter");f.isFunction(d.fromRaw)||f.isFunction(d.toRaw)||(d=new d);this.formatter=d;this.editor=e.resolveNameToClass(this.editor,
"CellEditor");this.listenTo(b,"change:"+a.get("name"),function(){c.hasClass("editor")||this.render()});this.listenTo(b,"backgrid:error",this.renderError);this.listenTo(a,"change:editable change:sortable change:renderable",function(a){a=a.changedAttributes();for(var b in a)a.hasOwnProperty(b)&&c.toggleClass(b,a[b])});e.callByNeed(a.editable(),a,b)&&c.addClass("editable");e.callByNeed(a.sortable(),a,b)&&c.addClass("sortable");e.callByNeed(a.renderable(),a,b)&&c.addClass("renderable")},render:function(){this.$el.empty();
var a=this.model;this.$el.text(this.formatter.fromRaw(a.get(this.column.get("name")),a));this.delegateEvents();return this},enterEditMode:function(){var a=this.model,b=this.column;e.callByNeed(b.editable(),b,a)&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),a.trigger("backgrid:edit",a,b,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),
a.trigger("backgrid:editing",a,b,this,this.currentEditor))},renderError:function(a,b){null!=b&&b.get("name")!=this.column.get("name")||this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error");this.currentEditor.remove();this.stopListening(this.currentEditor);delete this.currentEditor;this.$el.removeClass("editor");this.render()},remove:function(){this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor);return t.__super__.remove.apply(this,
arguments)}}),n=e.StringCell=t.extend({className:"string-cell",formatter:y}),G=e.UriCell=t.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(a){G.__super__.initialize.apply(this,arguments);this.title=a.title||this.title;this.target=a.target||this.target},render:function(){this.$el.empty();var a=this.model.get(this.column.get("name")),b=this.formatter.fromRaw(a,this.model);this.$el.append(w("\x3ca\x3e",{tabIndex:-1,href:a,title:this.title||b,target:this.target}).text(b));
this.delegateEvents();return this}});e.EmailCell=n.extend({className:"email-cell",formatter:z,render:function(){this.$el.empty();var a=this.model,a=this.formatter.fromRaw(a.get(this.column.get("name")),a);this.$el.append(w("\x3ca\x3e",{tabIndex:-1,href:"mailto:"+a,title:a}).text(a));this.delegateEvents();return this}});var A=e.NumberCell=t.extend({className:"number-cell",decimals:m.prototype.defaults.decimals,decimalSeparator:m.prototype.defaults.decimalSeparator,orderSeparator:m.prototype.defaults.orderSeparator,
formatter:m,initialize:function(a){A.__super__.initialize.apply(this,arguments);var b=this.formatter;b.decimals=this.decimals;b.decimalSeparator=this.decimalSeparator;b.orderSeparator=this.orderSeparator}});e.IntegerCell=A.extend({className:"integer-cell",decimals:0});var H=e.PercentCell=A.extend({className:"percent-cell",multiplier:r.prototype.defaults.multiplier,symbol:r.prototype.defaults.symbol,formatter:r,initialize:function(){H.__super__.initialize.apply(this,arguments);var a=this.formatter;
a.multiplier=this.multiplier;a.symbol=this.symbol}}),B=e.DatetimeCell=t.extend({className:"datetime-cell",includeDate:v.prototype.defaults.includeDate,includeTime:v.prototype.defaults.includeTime,includeMilli:v.prototype.defaults.includeMilli,formatter:v,initialize:function(a){B.__super__.initialize.apply(this,arguments);var b=this.formatter;b.includeDate=this.includeDate;b.includeTime=this.includeTime;b.includeMilli=this.includeMilli;b=this.includeDate?"YYYY-MM-DD":"";b+=this.includeDate&&this.includeTime?
"T":"";b+=this.includeTime?"HH:mm:ss":"";b+=this.includeTime&&this.includeMilli?".SSS":"";this.editor=this.editor.extend({attributes:f.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:b})})}});e.DateCell=B.extend({className:"date-cell",includeTime:!1});e.TimeCell=B.extend({className:"time-cell",includeDate:!1});r=e.BooleanCellEditor=s.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",
mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var a=this.model,a=this.formatter.fromRaw(a.get(this.column.get("name")),a);this.$el.prop("checked",a);return this},enterOrExitEditMode:function(a){if(!this.mouseDown){var b=this.model;b.trigger("backgrid:edited",b,this.column,new q(a))}},saveOrCancel:function(a){var b=this.model,c=this.column,d=this.formatter,h=new q(a);if(h.passThru()&&"change"!=a.type)return!0;h.cancel()&&(a.stopPropagation(),
b.trigger("backgrid:edited",b,c,h));var e=this.$el;h.save()||h.moveLeft()||h.moveRight()||h.moveUp()||h.moveDown()?(a.preventDefault(),a.stopPropagation(),a=d.toRaw(e.prop("checked"),b),b.set(c.get("name"),a),b.trigger("backgrid:edited",b,c,h)):"change"==a.type&&(a=d.toRaw(e.prop("checked"),b),b.set(c.get("name"),a),e.focus())}});e.BooleanCell=t.extend({className:"boolean-cell",editor:r,events:{click:"enterEditMode"},render:function(){this.$el.empty();var a=this.model,b=this.column,c=e.callByNeed(b.editable(),
b,a);this.$el.append(w("\x3cinput\x3e",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(a.get(b.get("name")),a),disabled:!c}));this.delegateEvents();return this}});var s=e.SelectCellEditor=s.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:f.template('\x3coption value\x3d"\x3c%- value %\x3e" \x3c%\x3d selected ? \'selected\x3d"selected"\' : "" %\x3e\x3e\x3c%- text %\x3e\x3c/option\x3e',null,{variable:null}),setOptionValues:function(a){this.optionValues=
a;this.optionValues=f.result(this,"optionValues")},setMultiple:function(a){this.multiple=a;this.$el.prop("multiple",a)},_renderOptions:function(a,b){for(var c="",d=0;d<a.length;d++)c+=this.template({text:a[d][0],value:a[d][1],selected:-1<f.indexOf(b,a[d][1])});return c},render:function(){this.$el.empty();var a=f.result(this,"optionValues"),b=this.model,b=this.formatter.fromRaw(b.get(this.column.get("name")),b);if(!f.isArray(a))throw new TypeError("optionValues must be an array");for(var c=null,d=
null,d=d=null,e=0;e<a.length;e++)if(c=a[e],f.isArray(c))d=c[0],c=c[1],this.$el.append(this.template({text:d,value:c,selected:-1<f.indexOf(b,c)}));else if(f.isObject(c))d=c.name,d=w("\x3coptgroup\x3e\x3c/optgroup\x3e",{label:d}),d.append(this._renderOptions.call(this,c.values,b)),this.$el.append(d);else throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");this.delegateEvents();return this},save:function(a){a=
this.model;a.set(this.column.get("name"),this.formatter.toRaw(this.$el.val(),a))},close:function(a){var b=this.model,c=this.column,d=new q(a);if(d.cancel())a.stopPropagation(),b.trigger("backgrid:edited",b,c,new q(a));else if(d.save()||d.moveLeft()||d.moveRight()||d.moveUp()||d.moveDown()||"blur"==a.type)a.preventDefault(),a.stopPropagation(),this.save(a),b.trigger("backgrid:edited",b,c,new q(a))}}),I=e.SelectCell=t.extend({className:"select-cell",editor:s,multiple:!1,formatter:k,optionValues:void 0,
delimiter:", ",initialize:function(a){I.__super__.initialize.apply(this,arguments);this.listenTo(this.model,"backgrid:edit",function(a,c,d,e){c.get("name")==this.column.get("name")&&(e.setOptionValues(this.optionValues),e.setMultiple(this.multiple))})},render:function(){this.$el.empty();var a=f.result(this,"optionValues"),b=this.model,b=this.formatter.fromRaw(b.get(this.column.get("name")),b),c=[];try{if(!f.isArray(a)||f.isEmpty(a))throw new TypeError;for(var d=0;d<b.length;d++)for(var e=b[d],g=0;g<
a.length;g++){var u=a[g];if(f.isArray(u)){var J=u[0],u=u[1];u==e&&c.push(J)}else if(f.isObject(u))for(var l=u.values,k=0;k<l.length;k++){var n=l[k];n[1]==e&&c.push(n[0])}else throw new TypeError;}this.$el.append(c.join(this.delimiter))}catch(m){if(m instanceof TypeError)throw new TypeError("'optionValues' must be of type {Array.\x3cArray\x3e|Array.\x3c{name: string, values: Array.\x3cArray\x3e}\x3e}");throw m;}this.delegateEvents();return this}}),p=e.Column=g.Model.extend({defaults:{name:void 0,label:void 0,
sortable:!0,editable:!0,renderable:!0,formatter:void 0,sortType:"cycle",sortValue:void 0,direction:null,cell:void 0,headerCell:void 0},initialize:function(){this.has("label")||this.set({label:this.get("name")},{silent:!0});var a=e.resolveNameToClass(this.get("headerCell"),"HeaderCell"),b=e.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:b,headerCell:a},{silent:!0})},sortValue:function(){var a=this.get("sortValue");return f.isString(a)?this[a]:f.isFunction(a)?a:function(a,c){return a.get(c)}}});
f.each(["sortable","renderable","editable"],function(a){p.prototype[a]=function(){var b=this.get(a);return f.isString(b)?this[b]:f.isFunction(b)?b:!!b}});var x=e.Columns=g.Collection.extend({model:p}),K=e.Row=g.View.extend({tagName:"tr",initialize:function(a){var b=this.columns=a.columns;b instanceof g.Collection||(b=this.columns=new x(b));for(var c=this.cells=[],d=0;d<b.length;d++)c.push(this.makeCell(b.at(d),a));this.listenTo(b,"add",function(b,d){var e=d.indexOf(b),f=this.makeCell(b,a);c.splice(e,
0,f);var g=this.$el;0===e?g.prepend(f.render().$el):e===d.length-1?g.append(f.render().$el):g.children().eq(e).before(f.render().$el)});this.listenTo(b,"remove",function(a,b,d){c[d.index].remove();c.splice(d.index,1)})},makeCell:function(a){return new (a.get("cell"))({column:a,model:this.model})},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.cells.length;b++)a.appendChild(this.cells[b].render().el);this.el.appendChild(a);this.delegateEvents();return this},
remove:function(){for(var a=0;a<this.cells.length;a++){var b=this.cells[a];b.remove.apply(b,arguments)}return g.View.prototype.remove.apply(this,arguments)}}),D=e.EmptyRow=g.View.extend({tagName:"tr",emptyText:null,initialize:function(a){this.emptyText=a.emptyText;this.columns=a.columns},render:function(){this.$el.empty();var a=document.createElement("td");a.setAttribute("colspan",this.columns.length);a.appendChild(document.createTextNode(f.result(this,"emptyText")));this.el.className="empty";this.el.appendChild(a);
return this}}),L=e.HeaderCell=g.View.extend({tagName:"th",events:{"click a":"onClick"},initialize:function(a){this.column=a.column;this.column instanceof p||(this.column=new p(this.column));a=this.column;var b=this.collection,c=this.$el;this.listenTo(a,"change:editable change:sortable change:renderable",function(a){a=a.changedAttributes();for(var b in a)a.hasOwnProperty(b)&&c.toggleClass(b,a[b])});this.listenTo(a,"change:direction",this.setCellDirection);this.listenTo(a,"change:name change:label",
this.render);e.callByNeed(a.editable(),a,b)&&c.addClass("editable");e.callByNeed(a.sortable(),a,b)&&c.addClass("sortable");e.callByNeed(a.renderable(),a,b)&&c.addClass("renderable");this.listenTo(b.fullCollection||b,"sort",this.removeCellDirection)},removeCellDirection:function(){this.$el.removeClass("ascending").removeClass("descending");this.column.set("direction",null)},setCellDirection:function(a,b){this.$el.removeClass("ascending").removeClass("descending");a.cid==this.column.cid&&this.$el.addClass(b)},
onClick:function(a){function b(a,b){"ascending"===d.get("direction")?f.trigger(g,b,"descending"):"descending"===d.get("direction")?f.trigger(g,b,null):f.trigger(g,b,"ascending")}function c(a,b){"ascending"===d.get("direction")?f.trigger(g,b,"descending"):f.trigger(g,b,"ascending")}a.preventDefault();var d=this.column,f=this.collection,g="backgrid:sort";e.callByNeed(d.sortable(),d,this.collection)&&("toggle"===d.get("sortType")?c(this,d):b(this,d))},render:function(){this.$el.empty();var a=this.column,
b;b=e.callByNeed(a.sortable(),a,this.collection)?w("\x3ca\x3e").text(a.get("label")).append("\x3cb class\x3d'sort-caret'\x3e\x3c/b\x3e"):document.createTextNode(a.get("label"));this.$el.append(b);this.$el.addClass(a.get("name"));this.$el.addClass(a.get("direction"));this.delegateEvents();return this}});e.HeaderRow=e.Row.extend({initialize:function(){e.Row.prototype.initialize.apply(this,arguments)},makeCell:function(a,b){var c=a.get("headerCell")||b.headerCell||L;return c=new c({column:a,collection:this.collection})}});
k=e.Header=g.View.extend({tagName:"thead",initialize:function(a){this.columns=a.columns;this.columns instanceof g.Collection||(this.columns=new x(this.columns));this.row=new e.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){this.$el.append(this.row.render().$el);this.delegateEvents();return this},remove:function(){this.row.remove.apply(this.row,arguments);return g.View.prototype.remove.apply(this,arguments)}});s=e.Body=g.View.extend({tagName:"tbody",initialize:function(a){this.columns=
a.columns;this.columns instanceof g.Collection||(this.columns=new x(this.columns));this.row=a.row||K;this.rows=this.collection.map(function(a){return new this.row({columns:this.columns,model:a})},this);this.emptyText=a.emptyText;this._unshiftEmptyRowMayBe();a=this.collection;this.listenTo(a,"add",this.insertRow);this.listenTo(a,"remove",this.removeRow);this.listenTo(a,"sort",this.refresh);this.listenTo(a,"reset",this.refresh);this.listenTo(a,"backgrid:sort",this.sort);this.listenTo(a,"backgrid:edited",
this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){if(0===this.rows.length&&null!=this.emptyText)return this.rows.unshift(new D({emptyText:this.emptyText,columns:this.columns})),!0},insertRow:function(a,b,c){this.rows[0]instanceof D&&this.rows.pop().remove();if(b instanceof g.Collection||c){c=new this.row({columns:this.columns,model:a});a=b.indexOf(a);this.rows.splice(a,0,c);b=this.$el;var d=b.children();c=c.render().$el;a>=d.length?b.append(c):d.eq(a).before(c);return this}this.collection.add(a,
b)},removeRow:function(a,b,c){if(c)return(f.isUndefined(c.render)||c.render)&&this.rows[c.index].remove(),this.rows.splice(c.index,1),this._unshiftEmptyRowMayBe()&&this.render(),this;this.collection.remove(a,b);this._unshiftEmptyRowMayBe()&&this.render()},refresh:function(){for(var a=0;a<this.rows.length;a++)this.rows[a].remove();this.rows=this.collection.map(function(a){return new this.row({columns:this.columns,model:a})},this);this._unshiftEmptyRowMayBe();this.render();this.collection.trigger("backgrid:refresh",
this);return this},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.rows.length;b++)a.appendChild(this.rows[b].render().el);this.el.appendChild(a);this.delegateEvents();return this},remove:function(){for(var a=0;a<this.rows.length;a++){var b=this.rows[a];b.remove.apply(b,arguments)}return g.View.prototype.remove.apply(this,arguments)},sort:function(a,b){if(!f.contains(["ascending","descending",null],b))throw new RangeError('direction must be one of "ascending", "descending" or `null`');
f.isString(a)&&(a=this.columns.findWhere({name:a}));var c=this.collection,d;d="ascending"===b?-1:"descending"===b?1:null;var e=this.makeComparator(a.get("name"),d,d?a.sortValue():function(a){return 1*a.cid.replace("c","")});g.PageableCollection&&c instanceof g.PageableCollection?(c.setSorting(d&&a.get("name"),d,{sortValue:a.sortValue()}),c.fullCollection?(null==c.fullCollection.comparator&&(c.fullCollection.comparator=e),c.fullCollection.sort(),c.trigger("backgrid:sorted",a,b,c)):c.fetch({reset:!0,
success:function(){c.trigger("backgrid:sorted",a,b,c)}})):(c.comparator=e,c.sort(),c.trigger("backgrid:sorted",a,b,c));a.set("direction",b);return this},makeComparator:function(a,b,c){return function(d,e){var f=c(d,a),g=c(e,a),k;1===b&&(k=f,f=g,g=k);return f===g?0:f<g?-1:1}},moveToNextCell:function(a,b,c){var d=this.collection.indexOf(a),f=this.columns.indexOf(b),g,k,l;if(-1===f)return this;this.rows[d].cells[f].exitEditMode();if(c.moveUp()||c.moveDown()||c.moveLeft()||c.moveRight()||c.save()){b=
this.columns.length;var n=b*this.collection.length;if(c.moveUp()||c.moveDown())k=d+(c.moveUp()?-1:1),(b=this.rows[k])?(d=b.cells[f],e.callByNeed(d.column.editable(),d.column,a)&&(d.enterEditMode(),a.trigger("backgrid:next",k,f,!1))):a.trigger("backgrid:next",k,f,!0);else if(c.moveLeft()||c.moveRight()){c=c.moveRight();for(var m=d*b+f+(c?1:-1);0<=m&&m<n;c?m++:m--)if(k=~~(m/b),l=m-k*b,d=this.rows[k].cells[l],f=e.callByNeed(d.column.renderable(),d.column,d.model),g=e.callByNeed(d.column.editable(),d.column,
a),f&&g){d.enterEditMode();a.trigger("backgrid:next",k,l,!1);break}m==n&&a.trigger("backgrid:next",~~(m/b),m-k*b,!0)}}return this}});e.Footer=g.View.extend({tagName:"tfoot",initialize:function(a){this.columns=a.columns;this.columns instanceof g.Collection||(this.columns=new e.Columns(this.columns))}});e.Grid=g.View.extend({tagName:"table",className:"backgrid",header:k,body:s,footer:null,initialize:function(a){a.columns instanceof g.Collection||(a.columns=new x(a.columns||this.columns));this.columns=
a.columns;var b=f.omit(a,"el id attributes className tagName events".split(" "));this.body=a.body||this.body;this.body=new this.body(b);if(this.header=a.header||this.header)this.header=new this.header(b);if(this.footer=a.footer||this.footer)this.footer=new this.footer(b);this.listenTo(this.columns,"reset",function(){this.header&&(this.header=new (this.header.remove().constructor)(b));this.body=new (this.body.remove().constructor)(b);this.footer&&(this.footer=new (this.footer.remove().constructor)(b));
this.render()})},insertRow:function(){this.body.insertRow.apply(this.body,arguments);return this},removeRow:function(){this.body.removeRow.apply(this.body,arguments);return this},insertColumn:function(){this.columns.add.apply(this.columns,arguments);return this},removeColumn:function(){this.columns.remove.apply(this.columns,arguments);return this},sort:function(){this.body.sort.apply(this.body,arguments);return this},render:function(){this.$el.empty();this.header&&this.$el.append(this.header.render().$el);
this.footer&&this.$el.append(this.footer.render().$el);this.$el.append(this.body.render().$el);this.delegateEvents();this.trigger("backgrid:rendered",this);return this},remove:function(){this.header&&this.header.remove.apply(this.header,arguments);this.body.remove.apply(this.body,arguments);this.footer&&this.footer.remove.apply(this.footer,arguments);return g.View.prototype.remove.apply(this,arguments)}});return e});
(function(d,e){"object"===typeof exports&&"function"===typeof require?module.exports=e(require("backbone")):"function"===typeof define&&define.amd?define(["backbone"],function(h){return e(h||d.Backbone)}):e(Backbone)})(this,function(d){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function h(a,c){if(null!=a){var b=a[c];return"function"===typeof b?a[c]():b}}d.LocalStorage=window.Store=function(a,c){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";
this.name=a;this.serializer=c||{serialize:function(a){return a===Object(a)?JSON.stringify(a):a},deserialize:function(a){return a&&JSON.parse(a)}};var b=this.localStorage().getItem(this.name);this.records=b&&b.split(",")||[]};(function(a,c){for(var b in c)a[b]=c[b];return a})(d.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){a.id||0===a.id||(a.id=e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e(),a.set(a.idAttribute,a.id));this.localStorage().setItem(this._itemName(a.id),
this.serializer.serialize(a));this.records.push(a.id.toString());this.save();return this.find(a)},update:function(a){this.localStorage().setItem(this._itemName(a.id),this.serializer.serialize(a));var c=a.id.toString(),b;a:{b=this.records;for(var d=b.length;d--;)if(b[d]===c){b=!0;break a}b=!1}b||(this.records.push(c),this.save());return this.find(a)},find:function(a){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(a.id)))},findAll:function(){for(var a=[],c=0,b;c<this.records.length;c++)b=
this.records[c],b=this.serializer.deserialize(this.localStorage().getItem(this._itemName(b))),null!=b&&a.push(b);return a},destroy:function(a){this.localStorage().removeItem(this._itemName(a.id));for(var c=a.id.toString(),b=0;b<this.records.length;b++)this.records[b]===c&&this.records.splice(b,1);this.save();return a},localStorage:function(){return localStorage},_clear:function(){var a=this.localStorage(),c=RegExp("^"+this.name+"-");a.removeItem(this.name);for(var b in a)c.test(b)&&a.removeItem(b);
this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(a){return this.name+"-"+a}});d.LocalStorage.sync=window.Store.sync=d.localSync=function(a,c,b){var e=h(c,"localStorage")||h(c.collection,"localStorage"),f,g,k=d.$?d.$.Deferred&&d.$.Deferred():d.Deferred&&d.Deferred();try{switch(a){case "read":f=void 0!=c.id?e.find(c):e.findAll();break;case "create":f=e.create(c);break;case "update":f=e.update(c);break;case "delete":f=e.destroy(c)}}catch(l){g=22===
l.code&&0===e._storageSize()?"Private browsing is unsupported":l.message}f?(b&&b.success&&("0.9.10"===d.VERSION?b.success(c,f,b):b.success(f)),k&&k.resolve(f)):(g=g?g:"Record Not Found",b&&b.error&&("0.9.10"===d.VERSION?b.error(c,g,b):b.error(g)),k&&k.reject(g));b&&b.complete&&b.complete(f);return k&&k.promise()};d.ajaxSync=d.sync;d.getSyncMethod=function(a,c){return c&&c.ajaxSync||!h(a,"localStorage")&&!h(a.collection,"localStorage")?d.ajaxSync:d.localSync};d.sync=function(a,c,b){return d.getSyncMethod(c,
b).apply(this,[a,c,b])};return d.LocalStorage});
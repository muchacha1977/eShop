(function(l){if("object"==typeof exports&&"function"==typeof require)module.exports=l(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],l);else if("undefined"!==typeof _&&"undefined"!==typeof Backbone){var q=Backbone.PageableCollection,p=l(_,Backbone);Backbone.PageableCollection.noConflict=function(){Backbone.PageableCollection=q;return p}}})(function(l,q){function p(a,b){if(!l.isNumber(a)||l.isNaN(a)||!l.isFinite(a)||~~a!==a)throw new TypeError("`"+
b+"` must be a finite integer");return a}function P(a){for(var b,c,e={},d=decodeURIComponent,f=a.split("\x26"),h=0,g=f.length;h<g;h++)b=f[h].split("\x3d"),a=b[0],b=b[1]||!0,a=d(a),b=d(b),c=e[a],z(c)?c.push(b):e[a]=c?[c,b]:b;return e}function E(a,b,c){if((a=a._events[b])&&a.length){var e=a[a.length-1],d=e.callback;e.callback=function(){try{d.apply(this,arguments),c()}catch(a){throw a;}finally{e.callback=d}}}else c()}var n=l.extend,r=l.omit,v=l.clone,s=l.each,I=l.pick,J=l.contains,F=l.isEmpty,G=l.pairs,
Q=l.invert,z=l.isArray,A=l.isFunction,K=l.isObject,x=l.keys,y=l.isUndefined,B=Math.ceil,L=Math.floor,H=Math.max,C=q.Collection.prototype,M=/[\s'"]/g,R=/[<>\s'"]/g,O=q.PageableCollection=q.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",
1:"desc"}},constructor:function(a,b){C.constructor.apply(this,arguments);b=b||{};var c=this.mode=b.mode||this.mode||w.mode,e=n({},w.queryParams,this.queryParams,b.queryParams||{});e.directions=n({},w.queryParams.directions,this.queryParams.directions,e.directions||{});this.queryParams=e;e=this.state=n({},w.state,this.state,b.state||{});e.currentPage=null==e.currentPage?e.firstPage:e.currentPage;z(a)||(a=a?[a]:[]);a=a.slice();"server"==c||null!=e.totalRecords||F(a)||(e.totalRecords=a.length);this.switchMode(c,
n({fetch:!1,resetState:!1,models:a},b));var d=b.comparator;e.sortKey&&!d&&this.setSorting(e.sortKey,e.order,b);"server"!=c&&(c=this.fullCollection,d&&b.full&&(this.comparator=null,c.comparator=d),b.full&&c.sort(),a&&!F(a)&&(this.reset(a,n({silent:!0},b)),this.getPage(e.currentPage),a.splice.apply(a,[0,a.length].concat(this.models))));this._initState=v(this.state)},_makeFullCollection:function(a,b){var c=["url","model","sync","comparator"],e=this.constructor.prototype,d,f,h,g={};d=0;for(f=c.length;d<
f;d++)h=c[d],y(e[h])||(g[h]=e[h]);g=new (q.Collection.extend(g))(a,b);d=0;for(f=c.length;d<f;d++)h=c[d],this[h]!==e[h]&&(g[h]=this[h]);return g},_makeCollectionEventHandler:function(a,b){return function(c,e,d,f){var h=a._handlers;s(x(h),function(c){var d=h[c];a.off(c,d);b.off(c,d)});var g=v(a.state),t=g.firstPage,k=g.pageSize,m=(0===t?g.currentPage:g.currentPage-1)*k,l=m+k;if("add"==c){var u,p,q,r;f=f||{};d==b?(p=b.indexOf(e),p>=m&&p<l&&(r=a,u=q=p-m)):(u=a.indexOf(e),p=m+u,r=b,q=y(f.at)?p:f.at+m);
f.onRemove||(++g.totalRecords,delete f.onRemove);a.state=a._checkState(g);if(r){r.add(e,n({},f||{},{at:q}));var N=u>=k?e:!y(f.at)&&q<l&&a.length>k?a.at(k):null;N&&E(d,c,function(){a.remove(N,{onAdd:!0})})}}if("remove"==c)if(f.onAdd)delete f.onAdd;else{--g.totalRecords?(u=g.totalPages=B(g.totalRecords/k),g.lastPage=0===t?u-1:u||t,g.currentPage>u&&(g.currentPage=g.lastPage)):(g.totalRecords=null,g.totalPages=null);a.state=a._checkState(g);var D,t=f.index;d==a?((D=b.at(l))?E(a,c,function(){a.push(D,
{onRemove:!0})}):!a.length&&g.totalRecords&&a.reset(b.models.slice(m-k,l-k),n({},f,{parse:!1})),b.remove(e)):t>=m&&t<l&&((D=b.at(l-1))&&E(a,c,function(){a.push(D,{onRemove:!0})}),a.remove(e),!a.length&&g.totalRecords&&a.reset(b.models.slice(m-k,l-k),n({},f,{parse:!1})))}"reset"==c&&(f=d,d=e,d==a&&null==f.from&&null==f.to?(g=b.models.slice(0,m),k=b.models.slice(m+a.models.length),b.reset(g.concat(a.models).concat(k),f)):d==b&&((g.totalRecords=b.models.length)||(g.totalRecords=null,g.totalPages=null),
"client"==a.mode&&(g.lastPage=g.currentPage=g.firstPage),a.state=a._checkState(g),a.reset(b.models.slice(m,l),n({},f,{parse:!1}))));"sort"==c&&(f=d,e===b&&a.reset(b.models.slice(m,l),n({},f,{parse:!1})));s(x(h),function(c){var d=h[c];s([a,b],function(a){a.on(c,d);a=a._events[c]||[];a.unshift(a.pop())})})}},_checkState:function(a){var b=this.mode,c=this.links,e=a.totalRecords,d=a.pageSize,f=a.currentPage,h=a.firstPage,g=a.totalPages;if(null!=e&&null!=d&&null!=f&&null!=h&&("infinite"==b?c:1)){e=p(e,
"totalRecords");d=p(d,"pageSize");f=p(f,"currentPage");h=p(h,"firstPage");if(1>d)throw new RangeError("`pageSize` must be \x3e\x3d 1");g=a.totalPages=B(e/d);if(0>h||1<h)throw new RangeError("`firstPage must be 0 or 1`");a.lastPage=0===h?H(0,g-1):g||h;if("infinite"==b){if(!c[f+""])throw new RangeError("No link found for page "+f);}else if(f<h||0<g&&(h?f>g:f>=g))throw new RangeError("`currentPage` must be firstPage \x3c\x3d currentPage "+(h?"\x3e":"\x3e\x3d")+" totalPages if "+h+"-based. Got "+f+".");
}return a},setPageSize:function(a,b){a=p(a,"pageSize");b=b||{first:!1};var c=this.state,e=B(c.totalRecords/a),d=e?H(c.firstPage,L(e*c.currentPage/c.totalPages)):c.firstPage,c=this.state=this._checkState(n({},c,{pageSize:a,currentPage:b.first?c.firstPage:d,totalPages:e}));return this.getPage(c.currentPage,r(b,["first"]))},switchMode:function(a,b){if(!J(["server","client","infinite"],a))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');b=b||{fetch:!0,resetState:!0};var c=
this.state=b.resetState?v(this._initState):this._checkState(n({},this.state));this.mode=a;var e=this,d=this.fullCollection,f=this._handlers=this._handlers||{},h;if("server"==a||d)"server"==a&&d&&(s(x(f),function(a){h=f[a];e.off(a,h);d.off(a,h)}),delete this._handlers,this._fullComparator=d.comparator,delete this.fullCollection);else{d=this._makeFullCollection(b.models||[],b);d.pageableCollection=this;this.fullCollection=d;var g=this._makeCollectionEventHandler(this,d);s(["add","remove","reset","sort"],
function(a){f[a]=h=l.bind(g,{},a);e.on(a,h);d.on(a,h)});d.comparator=this._fullComparator}if("infinite"==a)for(var t=this.links={},k=c.firstPage,m=B(c.totalRecords/c.pageSize),k=0===k?H(0,m-1):m||k,c=c.firstPage;c<=k;c++)t[c]=this.url;else this.links&&delete this.links;return b.fetch?this.fetch(r(b,"fetch","resetState")):this},hasPreviousPage:function(){var a=this.state,b=a.currentPage;return"infinite"!=this.mode?b>a.firstPage:!!this.links[b-1]},hasNextPage:function(){var a=this.state,b=this.state.currentPage;
return"infinite"!=this.mode?b<a.lastPage:!!this.links[b+1]},getFirstPage:function(a){return this.getPage("first",a)},getPreviousPage:function(a){return this.getPage("prev",a)},getNextPage:function(a){return this.getPage("next",a)},getLastPage:function(a){return this.getPage("last",a)},getPage:function(a,b){var c=this.mode,e=this.fullCollection;b=b||{fetch:!1};var d=this.state,f=d.firstPage,h=d.currentPage,g=d.lastPage,l=d.pageSize,k=a;switch(a){case "first":k=f;break;case "prev":k=h-1;break;case "next":k=
h+1;break;case "last":k=g;break;default:k=p(a,"index")}this.state=this._checkState(n({},d,{currentPage:k}));b.from=h;b.to=k;d=(0===f?k:k-1)*l;e=e&&e.length?e.models.slice(d,d+l):[];if(("client"==c||"infinite"==c&&!F(e))&&!b.fetch)return this.reset(e,r(b,"fetch")),this;"infinite"==c&&(b.url=this.links[k]);return this.fetch(r(b,"fetch"))},getPageByOffset:function(a,b){if(0>a)throw new RangeError("`offset must be \x3e 0`");a=p(a);var c=L(a/this.state.pageSize);0!==this.state.firstPage&&c++;c>this.state.lastPage&&
(c=this.state.lastPage);return this.getPage(c,b)},sync:function(a,b,c){var e=this;if("infinite"==e.mode){var d=c.success,f=e.state.currentPage;c.success=function(a,b,l){var k=e.links,m=e.parseLinks(a,n({xhr:l},c));m.first&&(k[e.state.firstPage]=m.first);m.prev&&(k[f-1]=m.prev);m.next&&(k[f+1]=m.next);d&&d(a,b,l)}}return(C.sync||q.sync).call(e,a,b,c)},parseLinks:function(a,b){var c={},e=b.xhr.getResponseHeader("Link");if(e){var d=["first","prev","next"];s(e.split(","),function(a){a=a.split(";");var b=
a[0].replace(R,"");a=a.slice(1);s(a,function(a){var e=a.split("\x3d");a=e[0].replace(M,"");e=e[1].replace(M,"");"rel"==a&&J(d,e)&&(c[e]=b)})})}return c},parse:function(a,b){var c=this.parseState(a,v(this.queryParams),v(this.state),b);c&&(this.state=this._checkState(n({},this.state,c)));return this.parseRecords(a,b)},parseState:function(a,b,c,e){if(a&&2===a.length&&K(a[0])&&z(a[1])){var d=v(c),f=a[0];s(G(r(b,"directions")),function(a){var b=a[0];a=a[1];var c=f[a];y(c)||l.isNull(c)||(d[b]=f[a])});f.order&&
(d.order=1*Q(b.directions)[f.order]);return d}},parseRecords:function(a,b){return a&&2===a.length&&K(a[0])&&z(a[1])?a[1]:a},fetch:function(a){a=a||{};var b=this._checkState(this.state),c=this.mode;"infinite"!=c||a.url||(a.url=this.links[b.currentPage]);var e=a.data||{},d=a.url||this.url||"";A(d)&&(d=d.call(this));var f=d.indexOf("?");-1!=f&&(n(e,P(d.slice(f+1))),d=d.slice(0,f));a.url=d;a.data=e;for(var h="client"==this.mode?I(this.queryParams,"sortKey","order"):r(I(this.queryParams,x(w.queryParams)),
"directions"),g,l,k,m=G(h),d=v(this),f=0;f<m.length;f++)g=m[f],l=g[0],k=g[1],k=A(k)?k.call(d):k,null!=b[l]&&null!=k&&(e[k]=b[l]);b.sortKey&&b.order?(f=A(h.order)?h.order.call(d):h.order,e[f]=this.queryParams.directions[b.order+""]):b.sortKey||delete e[h.order];b=G(r(this.queryParams,x(w.queryParams)));for(f=0;f<b.length;f++)g=b[f],k=g[1],k=A(k)?k.call(d):k,null!=k&&(e[g[0]]=k);if("server"!=c){var p=this,q=this.fullCollection,s=a.success;a.success=function(b,e,d){d=d||{};y(a.silent)?delete d.silent:
d.silent=a.silent;var f=b.models;"client"==c?q.reset(f,d):(q.add(f,n({at:q.length},n(d,{parse:!1}))),p.trigger("reset",p,d));s&&s(b,e,d)};return C.fetch.call(this,n({},a,{silent:!0}))}return C.fetch.call(this,a)},_makeComparator:function(a,b,c){var e=this.state;a=a||e.sortKey;b=b||e.order;if(a&&b)return c||(c=function(a,b){return a.get(b)}),function(d,e){var h=c(d,a),g=c(e,a),l;1===b&&(l=h,h=g,g=l);return h===g?0:h<g?-1:1}},setSorting:function(a,b,c){var e=this.state;e.sortKey=a;e.order=b=b||e.order;
var e=this.fullCollection,d=!1,f=!1;a||(d=f=!0);var h=this.mode;c=n({side:"client"==h?h:"server",full:!0},c);a=this._makeComparator(a,b,c.sortValue);b=c.full;c=c.side;"client"==c?b?(e&&(e.comparator=a),d=!0):(this.comparator=a,f=!0):"server"!=c||b||(this.comparator=a);d&&(this.comparator=null);f&&e&&(e.comparator=null);return this}}),w=O.prototype;return O});